<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <title>DOTD EV Calc w/ Fetcher</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      background-color: black;
      color: lightgray;
      text-align: center;
    }
    input, button, select, textarea {
      margin: 5px;
      padding: 15px;
      font-size: 16px;
      border-radius: 25px;
      border: 2px solid #ccc;
      transition: border-color 0.3s;
    }
    input, select, textarea {
      background-color: #333;
      color: lightgray;
      border: 2px solid #555;
    }
    textarea {
      width: 80%;
      height: 200px;
      border-radius: 15px;
      font-family: monospace;
    }
    input:focus, button:focus, select:focus, textarea:focus {
      border-color: #007bff;
      outline: none;
    }
    button {
      cursor: pointer;
      background-color: #6f42c1;
      color: white;
      border: none;
    }
    button:hover {
      background-color: #5a32a3;
    }
    #clearButton {
      background-color: red;
      margin-left: 10px;
    }
    a { color: #858bf0; }
    .calculator-section {
      border: 1px solid #444;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 20px;
      background-color: #1a1a1a;
      text-align: center;
    }
    .sorted-section {
      border: 1px solid #444;
      padding: 20px;
      margin: 20px auto;
      border-radius: 20px;
      background-color: #1a1a1a;
      text-align: center;
      max-width: 90%;
    }
    .sorted-item {
      margin-bottom: 8px;
      padding: 8px;
      background-color: #222;
      border-radius: 8px;
      text-align: left;
      position: relative;
    }
    .instructions {
      background-color: #2a2a3a;
      padding: 15px;
      border-radius: 15px;
      margin: 20px auto;
      max-width: 90%;
      text-align: left;
    }
    .error {
      color: #ff6b6b;
      background-color: #3a2222;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .warning {
      color: #ffd166;
      background-color: #3a2e22;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .auto-fix {
      color: #67c3d0;
      background-color: #22303a;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .tab-container {
      margin: 20px 0;
    }
    .tab-button {
      background-color: #333;
      border: none;
      padding: 10px 20px;
      margin: 0 5px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
    }
    .tab-button.active {
      background-color: #6f42c1;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #warnings {
      margin-top: 20px;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      background-color: #2a2a2a;
      display: none;
    }
    pre {
      text-align: left;
      background-color: #222;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .header-container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      margin-bottom: 20px;
    }
    .home-button {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background-color: #444;
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s ease;
    }
    .home-button:hover { background-color: #6f42c1; }
    .home-icon {
      width: 16px; height: 16px; fill: currentColor;
    }
    .team-header {
      font-weight: bold; color: #a5a1ff; margin-bottom: 5px;
    }
    @media (max-width: 600px) {
      .header-container { flex-direction: column; gap: 10px; }
      .home-button { position: static; transform: none; margin-bottom: 10px; }
      .calculator-actions { margin: 20px auto; text-align: center; }
      #calculateAllButton {
        background-color: #6f42c1; color: white; padding: 15px 30px;
        font-size: 18px; border-radius: 25px; border: none; cursor: pointer; margin: 20px auto; transition: background-color 0.3s;
      }
      #calculateAllButton:hover { background-color: #5a32a3; }
      .summary-group { margin-bottom: 15px; padding: 10px; background-color: #222; border-radius: 10px; }
      .summary-group h3 { margin-top: 0; color: #a5a1ff; }
      #clearButton { background-color: red; margin-left: 10px; }
    }
    .rankings-section {
      border: 1px solid #444;
      padding: 20px;
      margin: 20px auto;
      border-radius: 20px;
      background-color: #1a1a1a;
      text-align: center;
      max-width: 90%;
      display: none;
    }
    .ranking-item {
      margin-bottom: 12px;
      padding: 15px;
      background-color: #222;
      border-radius: 12px;
      text-align: left;
      position: relative;
      border-left: 4px solid #6f42c1;
    }
    .ranking-item.rank-1 { border-left: 4px solid #ffd700; background-color: #2a2619; }
    .ranking-item.rank-2 { border-left: 4px solid #c0c0c0; background-color: #252525; }
    .ranking-item.rank-3 { border-left: 4px solid #cd7f32; background-color: #2a2015; }
    .ranking-number { font-weight: bold; color: #a5a1ff; font-size: 18px; display: inline-block; width: 30px; }
    .ranking-team { font-weight: bold; color: #ffffff; font-size: 16px; }
    .ranking-details { color: #cccccc; font-size: 14px; margin-top: 5px; }
    .ranking-ev { color: #4ade80; font-weight: bold; }
    .ranking-payout { color: #fbbf24; }
    .ranking-prob { color: #60a5fa; }
    #showRankingsButton {
      background-color: #059669; color: white;
      padding: 15px 30px; font-size: 18px; border-radius: 25px; border: none;
      cursor: pointer; margin: 10px; transition: background-color 0.3s;
    }
    #showRankingsButton:hover { background-color: #047857; }
    
    /* Debug Panel Styles */
    .debug-panel {
      background-color: #1a1a2e;
      border: 2px solid #0f3460;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 95%;
      text-align: left;
      font-family: 'Courier New', monospace;
    }
    .debug-title {
      color: #16c79a;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }
    .debug-section {
      background-color: #0f0f23;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .debug-section h4 {
      color: #f39c12;
      margin: 0 0 10px 0;
      font-size: 14px;
    }
    .debug-info {
      color: #ecf0f1;
      font-size: 12px;
      line-height: 1.4;
      margin: 5px 0;
    }
    .debug-info.success { color: #27ae60; }
    .debug-info.error { color: #e74c3c; }
    .debug-info.warning { color: #f39c12; }
    .debug-info.info { color: #3498db; }
    .debug-timestamp {
      color: #95a5a6;
      font-size: 11px;
      font-style: italic;
    }
    .debug-json {
      background-color: #2c2c54;
      border: 1px solid #40407a;
      border-radius: 5px;
      padding: 10px;
      margin: 5px 0;
      white-space: pre-wrap;
      font-size: 11px;
      color: #ddd;
      max-height: 200px;
      overflow-y: auto;
    }
    .debug-controls {
      text-align: center;
      margin-bottom: 15px;
    }
    .debug-button {
      background-color: #2c3e50;
      color: white;
      border: none;
      padding: 8px 15px;
      margin: 0 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
    .debug-button:hover { background-color: #34495e; }
    .debug-button.active { background-color: #27ae60; }
  </style>
</head>
<body>
  <div class="header-container">
    <a href="https://real-ev-calcs.vercel.app/" class="home-button">
      <svg class="home-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
      </svg>
      Home
    </a>
    <h1>DOTD EV calc</h1>
  </div>
  <div class="tab-container">
    <button class="tab-button active" onclick="openTab('sorterTab')">Odds Sorter</button>
    <button class="tab-button" onclick="openTab('calculatorTab')">EV Calculator</button>
  </div>
  <h4>
   Uses dotd-fetcher made by @barry
  </h4>
  <a href="formatter.html" target="_blank">Formatter</a>
  <a href="help-dotd.html">How to use</a><br />

  <!-- Debug Panel -->
  <div class="debug-panel">
    <div class="debug-title">üêõ Debug Console</div>
    
    <div class="debug-controls">
      <button class="debug-button active" id="debugToggle" onclick="toggleDebugMode()">Debug ON</button>
      <button class="debug-button" onclick="clearDebugLog()">Clear Log</button>
      <button class="debug-button" onclick="exportDebugLog()">Export Log</button>
      <button class="debug-button" onclick="testConnection()">Test API</button>
    </div>

    <div class="debug-section">
      <h4>üì° API Connection Status</h4>
      <div class="debug-info" id="connectionStatus">Initializing...</div>
      <div class="debug-info" id="lastFetchTime">Last fetch: Never</div>
      <div class="debug-info" id="pollIdInfo">Poll ID: 268319</div>
    </div>

    <div class="debug-section">
      <h4>üìä Data Processing Info</h4>
      <div class="debug-info" id="dataStats">No data processed yet</div>
      <div class="debug-info" id="parsingErrors">Parsing errors: 0</div>
      <div class="debug-info" id="recordCount">Records found: 0</div>
    </div>

    <div class="debug-section">
      <h4>üîÑ Request Details</h4>
      <div class="debug-info" id="requestUrl">Request URL: Not set</div>
      <div class="debug-info" id="requestMethod">Method: GET</div>
      <div class="debug-info" id="cacheStatus">Cache busting: Enabled</div>
    </div>

    <div class="debug-section">
      <h4>üìã Live Debug Log</h4>
      <div class="debug-json" id="debugLog">Debug logging initialized...\n</div>
    </div>

    <div class="debug-section">
      <h4>üîç Raw API Response</h4>
      <div class="debug-json" id="rawResponse">No response data yet...</div>
    </div>

    <div class="debug-section">
      <h4>‚ö†Ô∏è Error Tracking</h4>
      <div class="debug-info error" id="errorCount">Errors: 0</div>
      <div class="debug-json" id="errorDetails">No errors recorded</div>
    </div>
  </div>

  <!-- Odds Sorter Tab -->
  <div id="sorterTab" class="tab-content active">
    <textarea id="inputData" placeholder="Paste the data below. The format should be like:
PHI +104
8% (563)
BAL +113
3% (241)
..."></textarea><br/>
     <button onclick="fetchPollData()">Refresh Data</button>
    <button onclick="processData()">Process and Sort Data</button>
    <button onclick="clearData()" id="clearButton">Clear Data</button>
    <div id="warnings"></div>
    <div id="sortedResults" class="sorted-section" style="display: none">
      <h2>Sorted Results:</h2>
      <div id="sortedItems"></div>
      <button id="useForCalculator" onclick="useForEVCalculator()">Use Data for EV Calculator &rarr;</button>
    </div>
  </div>

  <!-- EV Calculator Tab -->
  <div id="calculatorTab" class="tab-content">
    <br /><label for="calcCountSelect">Option Amount</label><br />
    <select id="calcCountSelect" onchange="generateCalculators()">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
      <option value="16">16</option>
      <option value="17">17</option>
      <option value="18">18</option>
      <option value="19">19</option>
      <option value="20">20</option>
    </select>
    <br />
    <button onclick="window.location.reload()">Reset</button>
    <br />
    <label>
      <input type="checkbox" id="globalNoVigCheckbox" onchange="toggleFavoriteInputs()" />
      Using No-Vig Odds for ALL?
    </label>
    <br /><br />
    <label>
      <input type="checkbox" id="shortenedModeToggle" onchange="toggleShortenedMode()">
      Shortened Mode (must have at least 10 bets)
    </label>      
    <div id="shortenedModeMsg" style="color:#ffd166; margin-bottom:10px; display:none;">
      Only bets with placement 7 or higher are shown.
    </div>
    <br>
    <div id="calculatorContainer"></div>
    <div class="calculator-actions">
      <button id="calculateAllButton" onclick="calculateAllEVs()">Calculate All</button>
      <button id="showRankingsButton" onclick="showCompleteRankings()">Show Complete EV Rankings</button>
    </div>
    <div id="summarySection" class="sorted-section" style="display: none">
      <h2>Best Options Summary</h2>
      <div class="summary-group">
        <h3>üèÜ Highest Expected Value</h3>
        <div class="sorted-item">
          <p><strong>Team:</strong> <span id="bestEVName">-</span></p>
          <p><strong>Expected Value:</strong> <span id="bestEVValue">-</span></p>
        </div>
      </div>
      <div class="summary-group">
        <h3>üí∞ Highest Payout</h3>
        <div class="sorted-item">
          <p><strong>Team:</strong> <span id="bestPayoutName">-</span></p>
          <p><strong>Karma Payout:</strong> <span id="bestPayoutValue">-</span></p>
        </div>
      </div>
      <div class="summary-group">
        <h3>üéØ Best Hit Probability</h3>
        <div class="sorted-item">
          <p><strong>Team:</strong> <span id="bestProbName">-</span></p>
          <p><strong>Hit Probability:</strong> <span id="bestProbValue">-</span>%</p>
        </div>
      </div>
    </div>
    <div id="rankingsSection" class="rankings-section" style="display:none;">
      <h2>üìä Complete EV Rankings</h2>
      <p style="color: #888; margin-bottom: 20px">
        All teams ranked by Expected Value (highest to lowest)
      </p>
      <div id="rankingsContainer"></div>
      <button onclick="hideRankings()" style="background-color: #666; color: white; padding: 10px 20px; border: none; border-radius: 15px; margin-top: 15px; cursor: pointer;">
        Hide Rankings
      </button>
    </div>
    <p>designed by @tomfc on Real</p>
  </div>

  <script>
    let teamsData = [];
    let shortenedMode = false;
    let debugMode = true;
    let debugLogEntries = [];
    let pollId = 268319;
    let errorCount = 0;

    // Debug Functions
    function logDebug(message, type = 'info', data = null) {
      if (!debugMode) return;
      
      const timestamp = new Date().toLocaleTimeString();
      const entry = {
        timestamp,
        message,
        type,
        data
      };
      
      debugLogEntries.push(entry);
      
      const debugLog = document.getElementById('debugLog');
      const colorClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info';
      
      debugLog.innerHTML += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
      if (data) {
        debugLog.innerHTML += `Data: ${JSON.stringify(data, null, 2)}\n`;
      }
      debugLog.innerHTML += '---\n';
      debugLog.scrollTop = debugLog.scrollHeight;
      
      // Update error count
      if (type === 'error') {
        errorCount++;
        document.getElementById('errorCount').textContent = `Errors: ${errorCount}`;
      }
    }

    function toggleDebugMode() {
      debugMode = !debugMode;
      const button = document.getElementById('debugToggle');
      button.textContent = debugMode ? 'Debug ON' : 'Debug OFF';
      button.classList.toggle('active', debugMode);
      
      logDebug(`Debug mode ${debugMode ? 'enabled' : 'disabled'}`, 'info');
    }

    function clearDebugLog() {
      debugLogEntries = [];
      document.getElementById('debugLog').innerHTML = 'Debug log cleared...\n';
      document.getElementById('rawResponse').innerHTML = 'No response data yet...';
      document.getElementById('errorDetails').innerHTML = 'No errors recorded';
      errorCount = 0;
      document.getElementById('errorCount').textContent = 'Errors: 0';
      logDebug('Debug log cleared', 'info');
    }

    function exportDebugLog() {
      const logData = {
        timestamp: new Date().toISOString(),
        entries: debugLogEntries,
        pollId: pollId,
        errorCount: errorCount
      };
      
      const blob = new Blob([JSON.stringify(logData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug-log-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      logDebug('Debug log exported', 'success');
    }

    function testConnection() {
      logDebug('Testing API connection...', 'info');
      document.getElementById('connectionStatus').textContent = 'Testing connection...';
      
      // Test basic connectivity
      const testUrl = 'https://api.allorigins.win/get?url=https://httpbin.org/status/200';
      
      axios.get(testUrl)
        .then(response => {
          logDebug('Connection test successful', 'success', { status: response.status });
          document.getElementById('connectionStatus').textContent = 'Connection: ‚úÖ Working';
          
          // Now test the actual API
          return testActualAPI();
        })
        .catch(error => {
          logDebug('Connection test failed', 'error', { error: error.message });
          document.getElementById('connectionStatus').textContent = 'Connection: ‚ùå Failed';
        });
    }

    function testActualAPI() {
      const cacheBust = Date.now();
      const testUrl = `https://api.allorigins.win/get?url=https://api.real.vg/polls/${pollId}&_cb=${cacheBust}`;
      
      logDebug('Testing actual API endpoint...', 'info', { url: testUrl });
      
      return axios.get(testUrl)
        .then(response => {
          logDebug('API test successful', 'success', { 
            status: response.status,
            dataLength: response.data ? response.data.contents?.length : 0
          });
          document.getElementById('connectionStatus').textContent = 'API: ‚úÖ Working';
          return response;
        })
        .catch(error => {
          logDebug('API test failed', 'error', { error: error.message });
          document.getElementById('connectionStatus').textContent = 'API: ‚ùå Failed';
          throw error;
        });
    }

    function updateDebugStats(options = []) {
      document.getElementById('dataStats').textContent = `Options processed: ${options.length}`;
      document.getElementById('recordCount').textContent = `Records found: ${options.length}`;
      
      const totalVotes = options.reduce((sum, option) => sum + (option.count || 0), 0);
      if (totalVotes > 0) {
        document.getElementById('dataStats').textContent += ` | Total votes: ${totalVotes}`;
      }
    }

    window.addEventListener('DOMContentLoaded', function() {
      logDebug('Page loaded, initializing...', 'info');
      
      const shortenedBox = document.getElementById("shortenedModeToggle");
      const msg = document.getElementById("shortenedModeMsg");
      if (shortenedBox) shortenedBox.checked = false;
      shortenedMode = false;
      if (msg) msg.style.display = "none";
      
      checkShortenedModeEligibility();
      generateCalculators();
      
      // Initialize debug info
      document.getElementById('pollIdInfo').textContent = `Poll ID: ${pollId}`;
      document.getElementById('connectionStatus').textContent = 'Initializing...';
      
      logDebug('Initialization complete', 'success');
    });

    function openTab(tabName) {
      logDebug(`Switching to tab: ${tabName}`, 'info');
      
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      document.getElementById(tabName).classList.add("active");
      const buttons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < buttons.length; i++) {
        if (buttons[i].textContent
          .toLowerCase()
          .includes(tabName.replace("Tab", "").toLowerCase())
        ) {
          buttons[i].classList.add("active");
        }
      }
    }

    function checkShortenedModeEligibility() {
      const shortenedBox = document.getElementById("shortenedModeToggle");
      const count = Number(document.getElementById("calcCountSelect").value);
      
      logDebug(`Checking shortened mode eligibility: ${count} options`, 'info');
      
      if (shortenedBox) {
        if (count < 10) {
          shortenedBox.checked = false;
          shortenedBox.disabled = true;
          shortenedMode = false;
          document.getElementById("shortenedModeMsg").style.display = "none";
        } else {
          shortenedBox.disabled = false;
          document.getElementById("shortenedModeMsg").textContent = "Only bets with placement 7 or higher are shown.";
        }
      }
    }
    
    function toggleShortenedMode() {
      const shortenedBox = document.getElementById("shortenedModeToggle");
      shortenedMode = shortenedBox && shortenedBox.checked;
      
      logDebug(`Shortened mode toggled: ${shortenedMode}`, 'info');
      
      generateCalculators();
      document.getElementById("shortenedModeMsg").style.display = shortenedMode ? "block" : "none";
    }

    function clearData() {
      logDebug('Clearing input data', 'info');
      document.getElementById("inputData").value = "";
    }

    function processData() {
      logDebug('Starting data processing...', 'info');
      
      const inputText = document.getElementById("inputData").value.trim();
      const sortedItemsDiv = document.getElementById("sortedItems");
      const warningsDiv = document.getElementById("warnings");
      const sortedResults = document.getElementById("sortedResults");

      warningsDiv.innerHTML = "";
      warningsDiv.style.display = "none";
      sortedItemsDiv.innerHTML = "";
      sortedResults.style.display = "none";
      teamsData = [];

      if (!inputText) {
        const error = 'No data provided for processing';
        logDebug(error, 'error');
        warningsDiv.innerHTML = '<p class="error">Please enter some data to sort.</p>';
        warningsDiv.style.display = "block";
        return;
      }

      logDebug(`Processing ${inputText.length} characters of input data`, 'info');

      try {
        const lines = inputText.split("\n").filter((line) => line.trim() !== "");
        const warnings = [];
        const autoFixes = [];
        
        logDebug(`Found ${lines.length} non-empty lines`, 'info');
        
        for (let i = 0; i < lines.length; i += 2) {
          if (i + 1 >= lines.length) {
            const warning = `Incomplete data at line ${i + 1}. Missing odds line.`;
            warnings.push(warning);
            logDebug(warning, 'warning');
            continue;
          }
          
          const teamLine = lines[i].trim();
          const oddsLine = lines[i + 1].trim();
          
          logDebug(`Processing team line: "${teamLine}"`, 'info');
          logDebug(`Processing odds line: "${oddsLine}"`, 'info');
          
          const teamMatch = teamLine.match(/^(\S+)\s+([+-]\d+)$/);
          if (!teamMatch) {
            const warning = `Invalid team/odds format at line ${i + 1}: "${teamLine}". Expected format: "TEAM +/-###"`;
            warnings.push(warning);
            logDebug(warning, 'warning');
            continue;
          }
          
          const team = teamMatch[1];
          const odds = teamMatch[2];
          const oddsValue = parseInt(odds);
          
          if (isNaN(oddsValue) || oddsValue < -999 || oddsValue > 999) {
            const warning = `Suspicious odds value for ${team}: ${odds}. Please verify.`;
            warnings.push(warning);
            logDebug(warning, 'warning');
          }
          
          let percentageMatch = oddsLine.match(/(\d+)%\s*\(([^)]+)\)/);
          if (!percentageMatch) {
            percentageMatch = oddsLine.match(/(\d+)%.*?\((\d+[k]?)\)/);
          }
          
          if (!percentageMatch) {
            const parensMatch = oddsLine.match(/\(([^)]+)\)/);
            if (parensMatch) {
              const numberInParentheses = parensMatch[1];
              logDebug(`Found parentheses value for ${team}: ${numberInParentheses}`, 'info');
              teamsData.push({
                team,
                odds,
                percentage: null,
                display: numberInParentheses,
                sortValue: parseNumericValue(numberInParentheses),
                needsPercentage: true,
              });
              continue;
            }
            
            const percentMatch = oddsLine.match(/(\d+)%/);
            if (percentMatch) {
              const percent = percentMatch[1];
              const numericMatch = oddsLine.match(/(\d+[k]?)/g);
              if (numericMatch && numericMatch.length > 1) {
                const numberInParentheses = numericMatch[1];
                teamsData.push({
                  team,
                  odds,
                  percentage: percent,
                  display: numberInParentheses,
                  sortValue: parseNumericValue(numberInParentheses),
                });
                const fix = `Fixed missing parentheses for ${team}: using ${numberInParentheses} as value.`;
                autoFixes.push(fix);
                logDebug(fix, 'info');
                continue;
              } else {
                const warning = `Missing number in parentheses for ${team}. Please add it manually.`;
                warnings.push(warning);
                logDebug(warning, 'warning');
                continue;
              }
            }
            
            const numericMatch = oddsLine.match(/(\d+[k]?)/g);
            if (numericMatch && numericMatch.length > 0) {
              const numberInParentheses = numericMatch[0];
              teamsData.push({
                team,
                odds,
                percentage: null,
                display: numberInParentheses,
                sortValue: parseNumericValue(numberInParentheses),
                needsPercentage: true,
              });
              const fix = `Extracted numeric value for ${team}: ${numberInParentheses} and will calculate percentage.`;
              autoFixes.push(fix);
              logDebug(fix, 'info');
              continue;
            }
            
            const warning = `Invalid odds line format at line ${i + 2}: "${oddsLine}". Expected format: "##% (###)"`;
            warnings.push(warning);
            logDebug(warning, 'warning');
            continue;
          }
          
          const percentage = percentageMatch[1];
          const numberInParentheses = percentageMatch[2];
          const percentValue = parseInt(percentage);
          
          if (isNaN(percentValue) || percentValue < 0 || percentValue > 100) {
            const warning = `Suspicious percentage value for ${team}: ${percentage}%. Please verify.`;
            warnings.push(warning);
            logDebug(warning, 'warning');
          }
          
          const sortValue = parseNumericValue(numberInParentheses);
          if (isNaN(sortValue)) {
            const warning = `Could not parse number value for ${team}: ${numberInParentheses}. Please verify.`;
            warnings.push(warning);
            logDebug(warning, 'warning');
            continue;
          }
          
          logDebug(`Successfully processed ${team}: ${odds}, ${percentage}%, ${numberInParentheses}`, 'success');
          
          teamsData.push({
            team,
            odds,
            percentage,
            display: numberInParentheses,
            sortValue,
          });
        }
        
        logDebug(`Processed ${teamsData.length} teams successfully`, 'success');
        document.getElementById('parsingErrors').textContent = `Parsing errors: ${warnings.length}`;
        
        const teamsWithMissingPercentage = teamsData.filter((team) => team.needsPercentage);
        if (teamsWithMissingPercentage.length > 0) {
          logDebug(`Calculating missing percentages for ${teamsWithMissingPercentage.length} teams`, 'info');
          calculateMissingPercentages(teamsWithMissingPercentage);
          teamsWithMissingPercentage.forEach((team) => {
            const fix = `Auto-calculated percentage for ${team.team}: ${team.percentage}% based on other entries.`;
            autoFixes.push(fix);
            logDebug(fix, 'success');
          });
        }

        // Deduplicate: assign displayTeam as "XYZ #1", "XYZ #2", etc. for duplicates
        let abbrevMap = {};
        teamsData.forEach(item => {
          if (!abbrevMap[item.team]) abbrevMap[item.team] = 0;
          abbrevMap[item.team]++;
        });
        
        let duplicateCount = 0;
        Object.values(abbrevMap).forEach(count => {
          if (count > 1) duplicateCount++;
        });
        
        if (duplicateCount > 0) {
          logDebug(`Found ${duplicateCount} duplicate team abbreviations, adding numbering`, 'info');
        }
        
        let runningCount = {};
        teamsData.forEach(item => {
          if (abbrevMap[item.team] > 1) {
            if (!runningCount[item.team]) runningCount[item.team] = 1;
            item.displayTeam = `${item.team} #${runningCount[item.team]}`;
            runningCount[item.team]++;
          } else {
            item.displayTeam = item.team;
          }
        });

        if (warnings.length > 0 || autoFixes.length > 0) {
          let warningsHTML = "<h3>Attention Required:</h3>";
          if (warnings.length > 0) {
            warningsHTML += '<div class="warning"><strong>Warnings - Manual Fix Needed:</strong><ul>';
            warnings.forEach((warning) => {
              warningsHTML += `<li>${warning}</li>`;
            });
            warningsHTML += "</ul></div>";
          }
          if (autoFixes.length > 0) {
            warningsHTML += '<div class="auto-fix"><strong>Auto-Fixed Issues:</strong><ul>';
            autoFixes.forEach((fix) => {
              warningsHTML += `<li>${fix}</li>`;
            });
            warningsHTML += "</ul></div>";
          }
          warningsDiv.innerHTML = warningsHTML;
          warningsDiv.style.display = "block";
        }
        
        teamsData.sort((a, b) => b.sortValue - a.sortValue);
        logDebug(`Sorted teams by value (highest first)`, 'info');
        
        if (teamsData.length === 0) {
          const error = 'No valid data was found after processing';
          logDebug(error, 'error');
          warningsDiv.innerHTML = '<p class="error">No valid data was found. Please check your input format.</p>';
          warningsDiv.style.display = "block";
          return;
        }
        
        teamsData.forEach((item, index) => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "sorted-item";
          itemDiv.innerHTML = `${index + 1}. ${item.displayTeam} (${item.odds}) - ${item.percentage}% (${item.display})`;
          sortedItemsDiv.appendChild(itemDiv);
        });
        
        sortedResults.style.display = "block";
        logDebug(`Data processing completed successfully. ${teamsData.length} teams displayed.`, 'success');
        
      } catch (error) {
        const errorMsg = `Error processing data: ${error.message}`;
        logDebug(errorMsg, 'error', { stack: error.stack });
        warningsDiv.innerHTML = `<p class="error">${errorMsg}</p>`;
        warningsDiv.style.display = "block";
        console.error("Processing error:", error);
      }
    }

    function parseNumericValue(str) {
      str = String(str).replace(/,/g, "");
      if (str.includes("k") || str.includes("K")) {
        return parseFloat(str.replace(/[kK]/i, "")) * 1000;
      } else {
        return parseFloat(str) || 0;
      }
    }
    
    function calculateMissingPercentages(teamsWithMissingPercentage) {
      const teamsWithPercentage = teamsData.filter((team) => !team.needsPercentage);
      if (teamsWithPercentage.length === 0) {
        const evenPercentage = Math.floor(100 / teamsData.length);
        teamsWithMissingPercentage.forEach((team) => {
          team.percentage = evenPercentage;
          delete team.needsPercentage;
        });
        return;
      }
      const totalKnownValue = teamsWithPercentage.reduce(
        (sum, team) => sum + team.sortValue,
        0
      );
      const totalKnownPercentage = teamsWithPercentage.reduce(
        (sum, team) => sum + parseInt(team.percentage),
        0
      );
      teamsWithMissingPercentage.forEach((team) => {
        const calculatedPercentage = Math.round(
          (team.sortValue / totalKnownValue) * totalKnownPercentage
        );
        team.percentage = Math.max(1, Math.min(calculatedPercentage, 50));
        delete team.needsPercentage;
      });
    }

    function useForEVCalculator() {
      logDebug('Transferring data to EV calculator', 'info');
      
      if (teamsData.length === 0) {
        const error = 'No valid data to use for calculator';
        logDebug(error, 'error');
        alert("No valid data to use. Please process your data first.");
        return;
      }
      if (teamsData.length < 8) {
        const warning = 'Not enough teams for shortened mode';
        logDebug(warning, 'warning');
        alert("You need at least 8 teams to use the shortened mode.");
        return;
      }
      
      const count = Math.min(teamsData.length, 20);
      document.getElementById("calcCountSelect").value = count;
      openTab("calculatorTab");
      generateCalculators();
      
      logDebug(`Populating calculator with ${count} teams`, 'info');
      
      setTimeout(() => {
        for (let i = 0; i < count; i++) {
          if (shortenedMode && i < 6) continue;
          if (i < teamsData.length) {
            const odds = teamsData[i].odds;
            const oddsValue = parseInt(odds.replace("+", ""));
            document.getElementById(`placementInput${i}`).value = Math.min(i + 1, 10);
            document.getElementById(`realOddsInput${i}`).value = oddsValue;
            const teamHeader = document.getElementById(`teamHeader${i}`);
            if (teamHeader) {
              teamHeader.textContent = teamsData[i].displayTeam;
            }
            logDebug(`Populated calculator ${i + 1} with ${teamsData[i].displayTeam}`, 'info');
          }
        }
        logDebug('Calculator population completed', 'success');
      }, 100);
    }
    
    function generateCalculators() {
      const count = Number(document.getElementById("calcCountSelect").value);
      const container = document.getElementById("calculatorContainer");
      
      logDebug(`Generating ${count} calculators (shortened mode: ${shortenedMode})`, 'info');
      
      let savedValues = {};
      for (let i = 0; i < count; i++) {
        savedValues[i] = {
          placement: document.getElementById(`placementInput${i}`)?.value || "",
          realOdds: document.getElementById(`realOddsInput${i}`)?.value || "",
          underdogOdds: document.getElementById(`underdogOddsInput${i}`)?.value || "",
          favoriteOdds: document.getElementById(`favoriteOddsInput${i}`)?.value || "",
          teamHeader: document.getElementById(`teamHeader${i}`)?.textContent || "",
        };
      }
      
      container.innerHTML = "";
      
      for (let i = 0; i < count; i++) {
        if (shortenedMode && i < 6) continue;
        const section = document.createElement("div");
        section.className = "calculator-section";
        section.innerHTML = `
          <h3>Bet ${i + 1}</h3>
          <div class="team-header" id="teamHeader${i}"></div>
          <input id="placementInput${i}" type="number" placeholder="Enter option placement (ex. 2)"><br>
          <input id="realOddsInput${i}" type="number" placeholder="Enter Real's Underdog Odds"><br>
          <input id="underdogOddsInput${i}" type="number" placeholder="Enter underdog's odds"><br>
          <div id="divFavoriteOddsInput${i}">
            <input id="favoriteOddsInput${i}" type="number" placeholder="Enter favorite's odds"><br>
          </div>
          <button onclick="calculateEV(${i})">Calculate</button>
          <button id="clearButton" onclick="clearInputs(${i})">Clear</button>
          <p id="resultsOutput${i}"></p>
        `;
        container.appendChild(section);
      }
      
      for (let i = 0; i < count; i++) {
        if (shortenedMode && i < 6) continue;
        if (savedValues[i]) {
          document.getElementById(`placementInput${i}`).value = savedValues[i].placement;
          document.getElementById(`realOddsInput${i}`).value = savedValues[i].realOdds;
          document.getElementById(`underdogOddsInput${i}`).value = savedValues[i].underdogOdds;
          document.getElementById(`favoriteOddsInput${i}`).value = savedValues[i].favoriteOdds;
          document.getElementById(`teamHeader${i}`).textContent = savedValues[i].teamHeader;
        }
      }
      
      toggleFavoriteInputs();
      checkShortenedModeEligibility();
      
      logDebug(`Calculator generation completed`, 'success');
    }
    
    document.getElementById("calcCountSelect").addEventListener("change", function() {
      checkShortenedModeEligibility();
      generateCalculators();
    });
    
    function toggleFavoriteInputs() {
      const useNoVig = document.getElementById("globalNoVigCheckbox").checked;
      const count = Number(document.getElementById("calcCountSelect").value);
      
      logDebug(`Toggling favorite inputs (no-vig: ${useNoVig})`, 'info');
      
      for (let i = 0; i < count; i++) {
        const favDiv = document.getElementById(`divFavoriteOddsInput${i}`);
        if (favDiv) {
          favDiv.style.display = useNoVig ? "none" : "block";
        }
      }
    }
    
    function calculateEV(index) {
      const team = document.getElementById(`teamHeader${index}`)?.textContent || `Bet ${index+1}`;
      const underdogOdds = Number(document.getElementById(`underdogOddsInput${index}`)?.value);
      let placement = Number(document.getElementById(`placementInput${index}`)?.value);
      placement = placement > 10 ? 10 : placement;
      const realOdds = Number(document.getElementById(`realOddsInput${index}`)?.value);
      const useNoVig = document.getElementById("globalNoVigCheckbox").checked;
      let favoriteOdds = useNoVig
        ? -1 * underdogOdds
        : Number(document.getElementById(`favoriteOddsInput${index}`)?.value);

      logDebug(`Calculating EV for ${team}`, 'info', {
        underdogOdds,
        placement,
        realOdds,
        favoriteOdds,
        useNoVig
      });

      const underdogIP =
        underdogOdds > 0
          ? 100 / (underdogOdds + 100)
          : Math.abs(underdogOdds) / (Math.abs(underdogOdds) + 100);

      const favoriteIP =
        favoriteOdds > 0
          ? 100 / (favoriteOdds + 100)
          : Math.abs(favoriteOdds) / (Math.abs(favoriteOdds) + 100);

      const ipTotal = favoriteIP + underdogIP;
      const novigUnderdogIP = underdogIP / ipTotal;

      let payout;
      if (realOdds < 0) {
        payout = Math.round(placement * 20 + (100 / (Math.abs(realOdds) / 100)));
      } else {
        payout = Math.round(placement * 20 + realOdds);
      }

      const expectedValue = payout * novigUnderdogIP;
      const hitProbPercent = novigUnderdogIP * 100;

      logDebug(`EV calculation completed for ${team}`, 'success', {
        ev: expectedValue,
        payout,
        hitProb: hitProbPercent
      });

      document.getElementById(`resultsOutput${index}`).textContent =
        `EV: ${expectedValue.toFixed(2)} | Payout: ${payout.toFixed(2)} | Hit Prob: ${hitProbPercent.toFixed(2)}%`;

      return {
        team: team,
        ev: expectedValue,
        payout: payout,
        hitProb: hitProbPercent
      };
    }
    
    function clearInputs(index) {
      logDebug(`Clearing inputs for calculator ${index + 1}`, 'info');
      
      document.getElementById(`underdogOddsInput${index}`).value = "";
      document.getElementById(`favoriteOddsInput${index}`).value = "";
      document.getElementById(`placementInput${index}`).value = "";
      document.getElementById(`realOddsInput${index}`).value = "";
      document.getElementById(`resultsOutput${index}`).textContent = "";
    }

    function calculateAllEVs() {
      const count = Number(document.getElementById("calcCountSelect").value);
      let results = [];
      
      logDebug(`Calculating EV for all ${count} calculators`, 'info');
      
      for (let i = 0; i < count; i++) {
        if (shortenedMode && i < 6) continue;
        results.push(calculateEV(i));
      }
      
      if (!results.length) {
        logDebug('No results to display', 'warning');
        return;
      }
      
      document.getElementById("summarySection").style.display = "block";
      let bestEV = results.reduce((a, b) => a.ev > b.ev ? a : b);
      let bestPayout = results.reduce((a, b) => a.payout > b.payout ? a : b);
      let bestProb = results.reduce((a, b) => a.hitProb > b.hitProb ? a : b);

      document.getElementById("bestEVName").textContent = bestEV.team || "-";
      document.getElementById("bestEVValue").textContent = bestEV.ev ? bestEV.ev.toFixed(2) : "-";
      document.getElementById("bestPayoutName").textContent = bestPayout.team || "-";
      document.getElementById("bestPayoutValue").textContent = bestPayout.payout ? bestPayout.payout.toFixed(2) : "-";
      document.getElementById("bestProbName").textContent = bestProb.team || "-";
      document.getElementById("bestProbValue").textContent = bestProb.hitProb ? bestProb.hitProb.toFixed(2) : "-";
      
      logDebug('All EV calculations completed and summary updated', 'success', {
        totalResults: results.length,
        bestEV: bestEV.team,
        bestPayout: bestPayout.team,
        bestProb: bestProb.team
      });
    }
    
    function showCompleteRankings() {
      const count = Number(document.getElementById("calcCountSelect").value);
      let results = [];
      
      logDebug('Generating complete EV rankings', 'info');
      
      for (let i = 0; i < count; i++) {
        if (shortenedMode && i < 6) continue;
        results.push(calculateEV(i));
      }
      
      results.sort((a, b) => b.ev - a.ev);
      
      const rankingsContainer = document.getElementById("rankingsContainer");
      rankingsContainer.innerHTML = "";
      
      results.forEach((r, idx) => {
        const div = document.createElement("div");
        div.className = "ranking-item" +
          (idx === 0 ? " rank-1" : idx === 1 ? " rank-2" : idx === 2 ? " rank-3" : "");
        div.innerHTML = `
          <span class="ranking-number">${idx + 1}.</span>
          <span class="ranking-team">${r.team}</span>
          <div class="ranking-details">
            <span class="ranking-ev">EV: ${r.ev.toFixed(2)}</span> |
            <span class="ranking-payout">Payout: ${r.payout.toFixed(2)}</span> |
            <span class="ranking-prob">Hit Prob: ${r.hitProb.toFixed(2)}%</span>
          </div>
        `;
        rankingsContainer.appendChild(div);
      });
      
      document.getElementById("rankingsSection").style.display = "block";
      
      logDebug(`Rankings displayed for ${results.length} teams`, 'success');
    }
    
    function hideRankings() {
      document.getElementById("rankingsSection").style.display = "none";
      logDebug('Rankings hidden', 'info');
    }

    async function fetchPollData() {
      logDebug('Starting poll data fetch...', 'info');
      document.getElementById('connectionStatus').textContent = 'Fetching data...';
      
      try {
        // Add cache busting parameter with current timestamp
        const cacheBust = Date.now();
        const url = `https://api.allorigins.win/get?url=https://api.real.vg/polls/${pollId}&_cb=${cacheBust}`;
        
        logDebug('Making API request...', 'info', { url, cacheBust });
        document.getElementById('requestUrl').textContent = `Request URL: ${url}`;
        document.getElementById('cacheStatus').textContent = `Cache busting: Enabled (${cacheBust})`;
        
        const response = await axios.get(url);
        
        logDebug('API request successful', 'success', {
          status: response.status,
          statusText: response.statusText,
          headers: response.headers
        });
        
        document.getElementById('connectionStatus').textContent = 'Connection: ‚úÖ Data received';
        document.getElementById('lastFetchTime').textContent = `Last fetch: ${new Date().toLocaleTimeString()}`;
        
        // Log raw response
        document.getElementById('rawResponse').textContent = JSON.stringify(response.data, null, 2);
        
        const data = JSON.parse(response.data.contents);
        
        logDebug('Response data parsed successfully', 'success', {
          pollId: data.poll.id,
          optionsCount: data.poll.options.length,
          pollTitle: data.poll.title
        });
        
        updateDebugStats(data.poll.options);
        displayPollResults(data.poll.options);
        
      } catch (error) {
        const errorMsg = `Fetch error: ${error.message}`;
        logDebug(errorMsg, 'error', {
          stack: error.stack,
          response: error.response?.data,
          status: error.response?.status
        });
        
        document.getElementById('connectionStatus').textContent = 'Connection: ‚ùå Failed';
        document.getElementById('inputData').value = 'Error: ' + error.message;
        document.getElementById('errorDetails').textContent = JSON.stringify({
          message: error.message,
          status: error.response?.status,
          data: error.response?.data
        }, null, 2);
        
        console.error('Error:', error);
      }
    }

    function displayPollResults(options) {
      logDebug(`Displaying poll results for ${options.length} options`, 'info');
      
      const totalVotes = options.reduce((sum, option) => sum + option.count, 0);
      
      logDebug(`Total votes: ${totalVotes}`, 'info');

      const textOutput = options.map(option => {
        const percentage = Math.round((option.count / totalVotes) * 100);
        return `${option.label} ${option.odds}\n${percentage}% (${option.count})`;
      }).join('\n');

      document.getElementById('inputData').value = textOutput;
      
      logDebug('Poll results displayed in textarea', 'success', {
        totalVotes,
        optionsCount: options.length,
        textLength: textOutput.length
      });
    }

    // Initialize on page load
    fetchPollData();
  </script>
</body>
</html>
